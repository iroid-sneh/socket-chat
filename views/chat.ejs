<!DOCTYPE html>
<html dir="ltr" lang="en">
    <head>
        <meta charset="utf-8" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <meta name="description" content="" />
        <meta name="author" content="" />
        <link rel="icon" type="image/png" sizes="16x16" href="/assets/images/favicon.png" />
        <title>Chat Template</title>
        <link href="/dist/css/style.min.css" rel="stylesheet" />
        <style>
            .chat-img img {
                object-fit: cover;
            }

            .chat-box {
                height: calc(100vh - 111px);
                overflow-y: auto;
            }

            .user-hover:hover {
                background-color: #f0f0f0;
                cursor: pointer;
            }

            .user-item img {
                object-fit: cover;
            }
            /* .box.msg {
                max-width: 70%;
                word-wrap: break-word;
            }
            .bg-primary {
                background-color: #007bff !important;
            }
            .bg-light {
                background-color: #f8f9fa !important;
            } */
            .rounded {
                border-radius: 18px !important;
            }
        </style>
    </head>

    <body>
        <input type="hidden" id="currentUserId" value="<%= senderId %>" />
        <input type="hidden" id="recipientUserId" value="<%= recipientId %>" />

        <div
            id="main-wrapper"
            data-theme="light"
            data-layout="vertical"
            data-navbarbg="skin6"
            data-sidebartype="full"
            data-sidebar-position="fixed"
            data-header-position="fixed"
            data-boxed-layout="full"
        >
            <div class="page-wrapper pt-0 mx-auto">
                <div class="container-fluid">
                    <div class="row">
                        <div class="col-md-12">
                            <div class="card mb-0">
                                <div class="row g-0">
                                    <div class="col-lg-3 col-xl-2 border-end">
                                        <div class="card-body border-bottom">
                                            <form>
                                                <input
                                                    class="form-control"
                                                    type="text"
                                                    placeholder="Search Contact"
                                                />
                                            </form>
                                        </div>
                                        <!-- <div class="border-bottom px-4 py-2 bg-light">
                                        <h5 id="chatHeader" class="mb-0">
                                            Select a user to start chat
                                        </h5>
                                    </div> -->
                                        <div
                                            class="scrollable position-relative"
                                            style="height: calc(100vh - 111px)"
                                        >
                                            <ul class="mailbox list-style-none">
                                                <li>
                                                    <div class="message-center">
                                                        <div id="user-list">
                                                            <ul id="user-list">
                                                                <% users.forEach(user=> { %>
                                                                <li
                                                                    class="user-item px-3 py-2 d-flex align-items-center user-hover"
                                                                >
                                                                    <a
                                                                        href="/api/v1/chat/<%= user._id %>"
                                                                        class="d-flex align-items-center text-decoration-none text-dark w-100"
                                                                    >
                                                                        <img
                                                                            src="<%= process.env.APP_URL_ADMIN %>/<%= user.image %>"
                                                                            alt="user"
                                                                            class="rounded-circle me-2"
                                                                            width="40"
                                                                            height="40"
                                                                        />
                                                                        <span class="fw-bold">
                                                                            <%= user.name %>
                                                                        </span>
                                                                    </a>
                                                                </li>
                                                                <% }) %>
                                                            </ul>
                                                        </div>
                                                    </div>
                                                </li>
                                            </ul>
                                        </div>
                                    </div>
                                    <div class="col-lg-9 col-xl-10">
                                        <div
                                            class="chat-box scrollable position-relative"
                                            style="height: calc(100vh - 111px)"
                                        >
                                            <ul
                                                class="chat-list list-style-none px-3 pt-3"
                                                id="chat-list"
                                            >
                                                <div
                                                    class="d-flex align-items-center px-3 py-2 border-bottom"
                                                >
                                                    <img
                                                        src="<%= process.env.APP_URL_ADMIN %>/<%= recipientImage %>"
                                                        alt="user"
                                                        class="rounded-circle me-2"
                                                        width="40"
                                                        height="40"
                                                    />
                                                    <h5 id="chatHeader" class="mb-0 fw-bold">
                                                        <%= recipientName %>
                                                    </h5>
                                                </div>

                                                <!-- Messages will appear here -->
                                            </ul>
                                        </div>
                                        <div class="card-body border-top">
                                            <div class="row">
                                                <div class="col-9">
                                                    <div class="input-field mt-0 mb-0">
                                                        <input
                                                            id="textarea1"
                                                            placeholder="Type and enter"
                                                            class="form-control border-0"
                                                            type="text"
                                                        />
                                                    </div>
                                                </div>
                                                <div class="col-3">
                                                    <a
                                                        class="btn-circle bg-cyan float-end text-white d-flex align-items-center justify-content-center"
                                                        id="sendBtn"
                                                        href="#"
                                                    >
                                                        <i class="fas fa-paper-plane"></i>
                                                    </a>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <script src="/socket.io/socket.io.js"></script>
        <script src="/assets/libs/jquery/dist/jquery.min.js"></script>
        <script src="/assets/libs/popper.js/dist/umd/popper.min.js"></script>
        <script src="/assets/libs/bootstrap/dist/js/bootstrap.bundle.min.js"></script>
        <script src="/dist/js/app-style-switcher.js"></script>
        <script src="/dist/js/feather.min.js"></script>
        <script src="/assets/libs/perfect-scrollbar/dist/perfect-scrollbar.jquery.min.js"></script>
        <script src="/dist/js/sidebarmenu.js"></script>
        <script src="/dist/js/custom.min.js"></script>

        <script>
            const socket = io();

            const senderId = document.getElementById("currentUserId").value;
            const recipientId = document.getElementById("recipientUserId").value;

            socket.emit("join", { userId: senderId });

            const chatBox = document.querySelector(".chat-box");
            let lastMessageId = null;
            // Send Message
            $("#textarea1").keypress(function (e) {
                if (e.keyCode === 13 && !e.shiftKey) {
                    e.preventDefault();
                    const msg = $(this).val().trim();
                    if (msg !== "") {
                        socket.emit("message", {
                            sender: senderId,
                            recipient: recipientId,
                            message: msg,
                            isGroup: false,
                        });
                        $(this).val("");
                    }
                }
            });

            // Receive message
            socket.on("message", (msg) => {
                const alignment = msg.senderId === senderId ? "odd text-end" : "";
                const bgClass = msg.senderId === senderId ? "bg-primary text-white" : "bg-light";

                const chatItem = `<li class="chat-item ${alignment} list-style-none mt-3">
                    <div class="chat-content d-inline-block ps-3">
                                    <div class="box msg p-2 d-inline-block mb-1 ${bgClass} rounded">${
                    msg.message
                }</div>
                    </div>
            <div class="chat-time d-block font-10 mt-1 mr-0 mb-2">
                ${new Date(msg.createdAt || Date.now()).toLocaleTimeString([], {
                    hour: "2-digit",
                    minute: "2-digit",
                })}
            </div>
        </div>
    </li>`;

                $("#chat-list").append(chatItem);
                chatBox.scrollTop = chatBox.scrollHeight;
                lastMessageId = msg._id;
            });

            // Switch recipient
            function setRecipient(id, name) {
                document.getElementById("recipientUserId").value = id;

                // Clear previous messages
                $("#chat-list").html("");

                // Emit to load chat history
                socket.emit("loadMessages", {
                    sender: senderId,
                    recipient: id,
                    isGroup: false,
                });
            }
        </script>
    </body>
</html>
